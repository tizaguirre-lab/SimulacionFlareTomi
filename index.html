<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flare Sim - V18 Logic Fixed</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* --- ESTILOS APP (Oscuro) --- */
        body { margin: 0; background-color: #0b0b0b; color: white; font-family: 'Segoe UI', monospace; overflow: hidden; user-select: none; touch-action: none; }

        /* Controles */
        #controls { position: absolute; top: 20px; left: 20px; background: rgba(15, 20, 25, 0.95); padding: 20px; border-left: 4px solid #00d2ff; border-radius: 0 10px 10px 0; box-shadow: 10px 0 30px rgba(0, 0, 0, 0.8); z-index: 20; width: 280px; max-height: 90vh; overflow-y: auto; }
        #dataPanel { position: absolute; top: 20px; right: 20px; background: rgba(30, 5, 5, 0.95); padding: 20px; border: 1px solid #552222; border-right: 4px solid #ff4444; border-radius: 8px; z-index: 30; width: 250px; text-align: right; cursor: move; box-shadow: 0 10px 20px rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        
        .btn-export { background-color: #442222; color: #ffaaaa; border: 1px solid #ff4444; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 15px; text-transform: uppercase; transition: 0.2s; font-size: 0.8rem; }
        .btn-export:hover { background-color: #ff4444; color: white; }

        .control-group { margin-bottom: 15px; }
        .sub-group { border-top: 1px solid #333; padding-top: 10px; margin-top: 10px; }
        .sub-title { font-size: 0.75rem; color: #888; text-transform: uppercase; margin-bottom: 10px; font-weight: bold;}
        label { display: block; margin-bottom: 5px; font-size: 0.8rem; color: #ccc; font-weight: 600;}
        input[type="range"] { width: 100%; cursor: pointer; accent-color: #00d2ff; height: 10px; }
        .value-display { float: right; color: #00d2ff; font-weight: bold; }
        .metric-big { font-size: 2rem; font-weight: bold; color: #fff; margin: 5px 0; letter-spacing: -1px;}
        .metric-unit { font-size: 1rem; color: #666; font-weight: normal;}
        .metric-sub { font-size: 0.9rem; color: #ffaaaa; margin-bottom: 10px; font-weight: bold;}
        .metric-desc { font-size: 0.7rem; color: #aaa; text-transform: uppercase;}
        .legend-item { display: flex; align-items: center; justify-content: flex-end; margin-top: 3px; font-size: 0.7rem; color: #bbb;}
        .dot { width: 8px; height: 8px; border-radius: 50%; margin-left: 8px; border: 1px solid rgba(255,255,255,0.2);}
        h3 { margin-top: 0; color: #00d2ff; font-size: 1rem; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 5px;}
        h4 { margin: 0; color: #ff4444; font-size: 1rem; text-transform: uppercase; display: inline-block;}
        .drag-hint { font-size: 0.6rem; color: #884444; float: left; margin-top: 4px;}
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; cursor: grab;}
        canvas:active { cursor: grabbing; }

        @media (max-width: 768px) {
            #controls { top: auto; bottom: 0; left: 0; width: 100%; max-width: none; border-left: none; border-top: 4px solid #00d2ff; border-radius: 20px 20px 0 0; max-height: 35vh; box-sizing: border-box; padding: 15px; }
            #dataPanel { width: auto; left: 10px !important; right: 10px !important; top: 10px !important; padding: 10px; font-size: 0.85em; }
        }

        /* --- ESTILOS REPORTE OCULTO --- */
        #print-container {
            position: absolute; top: 0; left: -9999px; /* Oculto */
            width: 794px; background: white; color: black;
            padding: 40px; box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
            visibility: hidden; 
        }
        
        .rep-header { border-bottom: 3px solid #333; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-end; }
        .rep-title { font-size: 24px; font-weight: 800; color: #222; line-height: 1.1; }
        .rep-meta { text-align: right; font-size: 11px; color: #666; }
        
        .rep-section { margin-bottom: 25px; page-break-inside: avoid; }
        .rep-sec-title { font-size: 14px; font-weight: 700; color: #0055aa; text-transform: uppercase; border-bottom: 1px solid #ccc; margin-bottom: 10px; padding-bottom: 3px; }
        
        .rep-box { background: #f8f8f8; border: 1px solid #ddd; padding: 15px; border-radius: 4px; text-align: center; }
        .rep-val-big { font-size: 32px; font-weight: 800; color: #333; display: block; margin: 5px 0; transition: color 0.3s;}
        .rep-label { font-size: 11px; text-transform: uppercase; color: #666; font-weight: 600; }

        .rep-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .rep-table td { padding: 6px 8px; border-bottom: 1px solid #eee; }
        .rep-table td:first-child { font-weight: 600; color: #444; width: 50%; background: #fdfdfd; }
        
        .rep-visuals { display: flex; justify-content: space-between; gap: 20px; margin-top: 15px; }
        .rep-vis-col { width: 48%; }
        .rep-canvas-img { width: 100%; border: 1px solid #eee; background: #fff; }
        .rep-caption { font-size: 10px; color: #777; text-align: center; margin-top: 4px; font-style: italic; }

        .rep-api-table th { background: #eee; font-weight: bold; text-align: left; padding: 6px; font-size: 11px; border-bottom: 2px solid #ccc; }
        .rep-api-table td { border: 1px solid #ddd; padding: 5px; font-size: 11px; vertical-align: middle;}
        .color-swatch { display: inline-block; width: 12px; height: 12px; margin-right: 8px; border: 1px solid rgba(0,0,0,0.1); vertical-align: middle; border-radius: 2px;}
    </style>
</head>
<body>

    <div id="help-overlay" style="position:absolute; bottom:20px; left:50%; transform:translateX(-50%); color:rgba(255,255,255,0.5); font-size:0.8rem; pointer-events:none; z-index:5;">üñ±Ô∏è Arrastra para GIRAR | üñ±Ô∏è Rueda para ZOOM</div>

    <div id="controls">
        <h3>Par√°metros</h3>
        <div class="control-group"><label>Altura Stack (m) <span class="value-display" id="heightVal">60</span></label><input type="range" id="stackHeight" min="10" max="150" value="60" step="1"></div>
        <div class="control-group"><label>Viento (m/s) <span class="value-display" id="windSpeedVal">5.0</span></label><input type="range" id="windSpeed" min="0" max="30" value="5" step="0.5"></div>
        <div class="control-group"><label>Direcci√≥n Viento <span class="value-display" id="windDirVal">0¬∞ (N)</span></label><input type="range" id="windAngle" min="0" max="360" value="0" step="1"></div>
        <div class="control-group"><label>Caudal Gas (t/h) <span class="value-display" id="flowVal">40</span></label><input type="range" id="gasFlow" min="5" max="150" value="40"></div>
        <div class="sub-group">
            <div class="sub-title">Asunciones de Dise√±o</div>
            <div class="control-group"><label>Di√°metro Tip (m) <span class="value-display" id="diamVal">0.8</span></label><input type="range" id="tipDiam" min="0.2" max="2.0" value="0.8" step="0.1"></div>
            <div class="control-group"><label>LHV (kWh/t) <span class="value-display" id="lhvVal">12900</span></label><input type="range" id="lhvInput" min="8000" max="15000" value="12900" step="100"></div>
            <div class="control-group"><label>Fracci√≥n (F) <span class="value-display" id="fVal">0.30</span></label><input type="range" id="fInput" min="0.10" max="0.50" value="0.30" step="0.01"></div>
        </div>
    </div>

    <div id="dataPanel">
        <div class="panel-header"><span class="drag-hint">::: ARRASTRAR :::</span><h4>Monitor SEP</h4></div>
        <div class="metric-desc">Radiaci√≥n M√°x en Suelo</div>
        <div class="metric-big"><span id="radValue">0.0</span> <span class="metric-unit">kW/m¬≤</span></div>
        <div class="metric-desc">Ubicaci√≥n del M√°ximo</div>
        <div class="metric-sub" id="radLoc">0m N, 0m E</div>
        <div style="border-top: 1px solid #442222; margin: 10px 0;"></div>
        <div class="metric-desc">Niveles API 521</div>
        <div class="legend-item">Da√±o Estructural (>9.45) <span class="dot" style="background: #990000;"></span></div>
        <div class="legend-item">Escape Emergencia (>6.3) <span class="dot" style="background: #ff0000;"></span></div>
        <div class="legend-item">L√≠mite Personal (>4.75) <span class="dot" style="background: #ff6600;"></span></div>
        <div class="legend-item">Expo. Limitada (>2.7) <span class="dot" style="background: #ffcc00;"></span></div>
        <div class="legend-item">Expo. Continua (>1.9) <span class="dot" style="background: #00ff00;"></span></div>
        <button class="btn-export" onclick="generateReport()">üìÑ Descargar PDF</button>
    </div>

    <canvas id="canvas"></canvas>

    <div id="print-container">
        <div class="rep-header">
            <div class="rep-title">INFORME T√âCNICO:<br>SIMULACI√ìN DE ANTORCHA</div>
            <div class="rep-meta">
                <strong>Fecha:</strong> <span id="r-date"></span><br>
                <strong>Metodolog√≠a:</strong> API 521 (Simple Point Source)
            </div>
        </div>

        <div class="rep-section">
            <div class="rep-sec-title">1. Resumen de Resultados</div>
            <div class="rep-box">
                <span class="rep-label">Radiaci√≥n T√©rmica M√°xima (Nivel Suelo)</span>
                <span class="rep-val-big" id="r-rad">0.00 kW/m¬≤</span>
                <span class="rep-label" style="color:#333;">Ubicaci√≥n: <span id="r-loc" style="font-weight:bold;"></span></span>
            </div>
        </div>

        <div class="rep-section">
            <div class="rep-sec-title">2. Par√°metros de Dise√±o y Visualizaci√≥n</div>
            <div class="rep-visuals">
                <div class="rep-vis-col">
                    <table class="rep-table">
                        <tr><td>Caudal de Gas</td><td id="r-flow"></td></tr>
                        <tr><td>Altura Stack</td><td id="r-height"></td></tr>
                        <tr><td>Di√°metro Tip</td><td id="r-diam"></td></tr>
                        <tr><td>Viento</td><td id="r-wind"></td></tr>
                        <tr><td>LHV</td><td id="r-lhv"></td></tr>
                        <tr><td>Fracci√≥n (F)</td><td id="r-f"></td></tr>
                    </table>
                    <div style="margin-top:15px; border:1px solid #ddd; padding:5px;">
                        <img id="img-schema" class="rep-canvas-img" />
                    </div>
                    <div class="rep-caption">Fig 1. Esquema Constructivo</div>
                </div>
                <div class="rep-vis-col">
                    <div style="border:1px solid #ddd; padding:5px; height:100%;">
                        <img id="img-radar" class="rep-canvas-img" />
                    </div>
                    <div class="rep-caption">Fig 2. Curvas de Iso-Radiaci√≥n (Planta)</div>
                </div>
            </div>
        </div>

        <div class="rep-section">
            <div class="rep-sec-title">Anexo: Niveles de Referencia (API 521)</div>
            <table class="rep-table rep-api-table">
                <tr><th>Nivel (kW/m¬≤)</th><th>Consecuencia / L√≠mite</th></tr>
                <tr><td><span class="color-swatch" style="background:#900;"></span> > 9.45</td><td>Da√±o a equipos y estructuras.</td></tr>
                <tr><td><span class="color-swatch" style="background:#f00;"></span> > 6.30</td><td>Escape de emergencia necesario.</td></tr>
                <tr><td><span class="color-swatch" style="background:#f60;"></span> > 4.75</td><td>L√≠mite para personal (2-3 min) con ropa adecuada.</td></tr>
                <tr><td><span class="color-swatch" style="background:#fa0;"></span> > 2.70</td><td>Exposici√≥n limitada.</td></tr>
                <tr><td><span class="color-swatch" style="background:#0a0;"></span> > 1.90</td><td>Exposici√≥n continua permitida.</td></tr>
            </table>
        </div>
    </div>

    <canvas id="c-schema" width="400" height="300" style="display:none;"></canvas>
    <canvas id="c-radar" width="400" height="400" style="display:none;"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Variables
        let particles = [], stars = [];
        let windSpeed=5, windAngleDeg=0, gasFlow=40, stackHeightMeters=60, tipDiameter=0.8, lhvValue=12900, radFraction=0.30;
        let flameCenter = {x:0, y:0, z:0}, maxGroundRadiation=0, qRadiantGlobal=0;
        let groundY = canvas.height - 50, torchY = 0, centerX = canvas.width/2, pixelsPerMeter = 4;
        let cameraAngle=0, cameraZoom=1.0, isCamDragging=false, lastCamX=0;

        // UI
        const ui = {
            h: document.getElementById('stackHeight'), w: document.getElementById('windSpeed'), a: document.getElementById('windAngle'),
            fl: document.getElementById('gasFlow'), d: document.getElementById('tipDiam'), lhv: document.getElementById('lhvInput'),
            f: document.getElementById('fInput'), panel: document.getElementById('dataPanel')
        };

        ui.h.addEventListener('input', (e)=>{ stackHeightMeters=parseInt(e.target.value); document.getElementById('heightVal').innerText=stackHeightMeters; particles=[]; });
        ui.w.addEventListener('input', (e)=>{ windSpeed=parseFloat(e.target.value); document.getElementById('windSpeedVal').innerText=windSpeed.toFixed(1); });
        ui.a.addEventListener('input', (e)=>{ windAngleDeg=parseInt(e.target.value); const d=["N","NE","E","SE","S","SO","O","NO"]; document.getElementById('windDirVal').innerText=windAngleDeg+"¬∞ ("+d[Math.round(windAngleDeg/45)%8]+")"; });
        ui.fl.addEventListener('input', (e)=>{ gasFlow=parseInt(e.target.value); document.getElementById('flowVal').innerText=gasFlow; });
        ui.d.addEventListener('input', (e)=>{ tipDiameter=parseFloat(e.target.value); document.getElementById('diamVal').innerText=tipDiameter; });
        ui.lhv.addEventListener('input', (e)=>{ lhvValue=parseInt(e.target.value); document.getElementById('lhvVal').innerText=lhvValue; });
        ui.f.addEventListener('input', (e)=>{ radFraction=parseFloat(e.target.value); document.getElementById('fVal').innerText=radFraction.toFixed(2); });

        // C√°mara
        canvas.addEventListener('mousedown', (e)=>{ isCamDragging=true; lastCamX=e.clientX; });
        window.addEventListener('mousemove', (e)=>{ if(isCamDragging){ cameraAngle+=(e.clientX-lastCamX)*0.005; lastCamX=e.clientX; } });
        window.addEventListener('mouseup', ()=>{ isCamDragging=false; });
        canvas.addEventListener('wheel', (e)=>{ e.preventDefault(); cameraZoom+=e.deltaY*-0.001; if(cameraZoom<0.5)cameraZoom=0.5; if(cameraZoom>2.5)cameraZoom=2.5; });
        canvas.addEventListener('touchstart', (e)=>{ if(e.touches.length===1){ lastCamX=e.touches[0].clientX; isCamDragging=true; } });
        canvas.addEventListener('touchmove', (e)=>{ if(isCamDragging&&e.touches.length===1){ cameraAngle+=(e.touches[0].clientX-lastCamX)*0.005; lastCamX=e.touches[0].clientX; } });
        canvas.addEventListener('touchend', ()=>{ isCamDragging=false; });

        // Panel Drag
        let isPD=false, sX, sY, iL, iT;
        ui.panel.addEventListener('mousedown', (e)=>{ e.stopPropagation(); isPD=true; sX=e.clientX; sY=e.clientY; const r=ui.panel.getBoundingClientRect(); iL=r.left; iT=r.top; ui.panel.style.cursor='grabbing'; });
        window.addEventListener('mousemove', (e)=>{ if(isPD){ ui.panel.style.right='auto'; ui.panel.style.left=(iL+(e.clientX-sX))+'px'; ui.panel.style.top=(iT+(e.clientY-sY))+'px'; } });
        window.addEventListener('mouseup', ()=>{ isPD=false; ui.panel.style.cursor='move'; });
        ui.panel.addEventListener('touchstart', (e)=>{ e.stopPropagation(); isPD=true; sX=e.touches[0].clientX; sY=e.touches[0].clientY; const r=ui.panel.getBoundingClientRect(); iL=r.left; iT=r.top; }, {passive:false});
        window.addEventListener('touchmove', (e)=>{ if(isPD){ ui.panel.style.right='auto'; ui.panel.style.left=(iL+(e.touches[0].clientX-sX))+'px'; ui.panel.style.top=(iT+(e.touches[0].clientY-sY))+'px'; } }, {passive:false});
        window.addEventListener('touchend', ()=>{ isPD=false; });

        for(let i=0; i<100; i++) stars.push({x:Math.random()*window.innerWidth, y:Math.random()*window.innerHeight*0.6, size:Math.random()*2, alpha:Math.random()});

        /* --- GENERACI√ìN DEL REPORTE --- */
        async function generateReport() {
            const d = new Date();
            document.getElementById('r-date').innerText = d.toLocaleString();
            
            const rRadEl = document.getElementById('r-rad');
            rRadEl.innerText = maxGroundRadiation.toFixed(2) + " kW/m¬≤";
            // Color matching
            if(maxGroundRadiation > 9.45) rRadEl.style.color = '#900';
            else if(maxGroundRadiation > 6.3) rRadEl.style.color = '#f00';
            else if(maxGroundRadiation > 4.75) rRadEl.style.color = '#f60';
            else if(maxGroundRadiation > 2.7) rRadEl.style.color = '#fa0';
            else if(maxGroundRadiation > 1.9) rRadEl.style.color = '#0a0';
            else rRadEl.style.color = '#333';

            document.getElementById('r-loc').innerText = document.getElementById('radLoc').innerText;
            document.getElementById('r-flow').innerText = gasFlow + " t/h";
            document.getElementById('r-height').innerText = stackHeightMeters + " m";
            document.getElementById('r-diam').innerText = tipDiameter + " m";
            document.getElementById('r-wind').innerText = windSpeed + " m/s (" + document.getElementById('windDirVal').innerText + ")";
            document.getElementById('r-lhv').innerText = lhvValue + " kWh/t";
            document.getElementById('r-f').innerText = radFraction;

            drawReportSchema();
            drawReportRadarImg();

            const cSchema = document.getElementById('c-schema');
            const cRadar = document.getElementById('c-radar');
            document.getElementById('img-schema').src = cSchema.toDataURL('image/png');
            document.getElementById('img-radar').src = cRadar.toDataURL('image/png');

            await new Promise(r => setTimeout(r, 100));

            const element = document.getElementById('print-container');
            element.style.visibility = 'visible'; 
            const canvasRender = await html2canvas(element, { scale: 2 });
            element.style.visibility = 'hidden';

            const imgDataReport = canvasRender.toDataURL('image/jpeg', 1.0);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const w = doc.internal.pageSize.getWidth();
            const h = (canvasRender.height * w) / canvasRender.width;
            
            doc.addImage(imgDataReport, 'JPEG', 0, 0, w, h);
            doc.save(`Informe_Flare_${d.toISOString().slice(0,10)}.pdf`);
        }

        function drawReportSchema() {
            const c = document.getElementById('c-schema'); const cx = c.getContext('2d');
            cx.clearRect(0,0,c.width,c.height); cx.fillStyle='white'; cx.fillRect(0,0,c.width,c.height);
            cx.strokeStyle='#333'; cx.fillStyle='#333'; cx.font="14px Arial"; cx.textAlign="center"; cx.lineWidth=2;
            const gY=250, cX=100;
            cx.beginPath(); cx.moveTo(20,gY); cx.lineTo(180,gY); cx.stroke();
            cx.lineWidth=1; for(let i=20;i<180;i+=8){cx.moveTo(i,gY);cx.lineTo(i-4,gY+4);} cx.stroke();
            const h=180, tY=gY-h, bW=50, tW=15;
            cx.lineWidth=2; cx.beginPath(); cx.moveTo(cX-bW/2,gY); cx.lineTo(cX-tW/2,tY); cx.moveTo(cX+bW/2,gY); cx.lineTo(cX+tW/2,tY);
            cx.moveTo(cX-bW/2,gY); cx.lineTo(cX+bW/2,gY-60); cx.lineTo(cX-bW/2+8,gY-120); cx.lineTo(cX-tW/2,tY); cx.strokeRect(cX-tW/2, tY-5, tW, 5); cx.stroke();
            cx.strokeStyle='#d00'; cx.fillStyle='#d00'; const dX=cX+40;
            cx.beginPath(); cx.moveTo(dX,gY); cx.lineTo(dX,tY-5); cx.stroke();
            cx.beginPath(); cx.moveTo(dX-4,gY-8); cx.lineTo(dX,gY); cx.lineTo(dX+4,gY-8); cx.fill();
            cx.beginPath(); cx.moveTo(dX-4,tY+3); cx.lineTo(dX,tY-5); cx.lineTo(dX+4,tY+3); cx.fill();
            cx.fillText(`h=${stackHeightMeters}m`, dX+10, gY-h/2); cx.fillStyle='#000'; cx.fillText("VISTA FRENTE", cX, 30);
            const tcX=300, tcY=130;
            cx.strokeStyle='#333'; cx.lineWidth=3; cx.beginPath(); cx.arc(tcX,tcY,30,0,Math.PI*2); cx.stroke();
            cx.lineWidth=1; cx.beginPath(); cx.arc(tcX,tcY,22,0,Math.PI*2); cx.stroke();
            cx.strokeStyle='#d00'; cx.fillStyle='#d00'; cx.beginPath(); cx.moveTo(tcX-30, tcY+40); cx.lineTo(tcX+30, tcY+40); cx.stroke();
            cx.fillText(`√ò=${tipDiameter}m`, tcX, tcY+58); cx.fillStyle='#000'; cx.fillText("TIP", tcX, 30);
        }

        // Radar para PDF (Fondo Blanco)
        function drawReportRadarImg() {
            const c = document.getElementById('c-radar'); const cx = c.getContext('2d');
            const w=c.width, h=c.height, cX=w/2, cY=h/2;
            cx.clearRect(0,0,w,h); cx.fillStyle='white'; cx.fillRect(0,0,w,h);
            const scalePx = (h/2 - 40) / 150; 
            cx.strokeStyle='#ddd'; cx.lineWidth=1; cx.textAlign="center"; cx.fillStyle="#666"; cx.font="12px Arial";
            [50, 100, 150].forEach(d => { const r = d * scalePx; cx.beginPath(); cx.arc(cX, cY, r, 0, Math.PI*2); cx.stroke(); cx.fillText(d+"m", cX, cY - r - 2); });
            cx.strokeStyle='#aaa'; cx.beginPath(); cx.moveTo(cX,0); cx.lineTo(cX,h); cx.stroke(); cx.beginPath(); cx.moveTo(0,cY); cx.lineTo(w,cY); cx.stroke();
            cx.fillStyle='#000'; cx.font="bold 14px Arial"; cx.fillText("N", cX, 15); cx.fillText("S", cX, h-5); cx.fillText("E", w-10, cY+5); cx.fillText("O", 10, cY+5);
            
            function getR(kw) { if(kw<=0)return 0; return Math.sqrt(qRadiantGlobal/(4*Math.PI*kw)) * scalePx; }
            const niveles = [{k:1.9,c:'rgba(0,255,0,0.1)',s:'#0a0'}, {k:2.7,c:'rgba(255,200,0,0.1)',s:'#fa0'}, {k:4.75,c:'rgba(255,100,0,0.2)',s:'#f60'}, {k:6.3,c:'rgba(255,0,0,0.2)',s:'#f00'}, {k:9.45,c:'rgba(150,0,0,0.3)',s:'#900'}];
            const fxM = flameCenter.x/pixelsPerMeter, fzM = flameCenter.z/pixelsPerMeter;
            const rcX = cX + (fxM * scalePx), rcY = cY + (fzM * scalePx);
            
            // L√ìGICA CORREGIDA: Solo dibujar si se supera el nivel
            niveles.forEach(n => { 
                if(maxGroundRadiation >= n.k) {
                    const r = getR(n.k); 
                    if(r>0){ cx.beginPath(); cx.arc(rcX, rcY, r, 0, Math.PI*2); cx.fillStyle=n.c; cx.fill(); cx.strokeStyle=n.s; cx.stroke(); } 
                }
            });
            
            if(maxGroundRadiation>0.1){ cx.strokeStyle='#000'; cx.lineWidth=2; cx.beginPath(); cx.moveTo(rcX-5,rcY-5); cx.lineTo(rcX+5,rcY+5); cx.moveTo(rcX+5,rcY-5); cx.lineTo(rcX-5,rcY+5); cx.stroke(); }
            cx.fillStyle='#00d2ff'; cx.fillRect(cX-4,cY-4,8,8);
        }

        // --- SIMULACI√ìN ---
        class Particle {
            constructor() {
                this.x = (Math.random()-0.5)*(tipDiameter*3); this.y = 0; this.z = (Math.random()-0.5)*(tipDiameter*3);
                const vFactor = gasFlow/(tipDiameter*tipDiameter); const vy = (Math.random()*2+1)+(vFactor*0.05);
                this.vx = (Math.random()-0.5)*1.5; this.vy = -vy; this.vz = (Math.random()-0.5)*1.5;
                this.baseSize = Math.random()*15+10+(gasFlow/5); this.life = 100;
                this.r = 255; this.g = Math.floor(Math.random()*150+100);
            }
            update() {
                const rad = (windAngleDeg-90)*(Math.PI/180);
                const stiffness = 1/(Math.abs(this.vy)+0.1);
                const wFactor = (100-this.life)*0.005*stiffness;
                this.vx += Math.cos(rad)*windSpeed*wFactor; this.vz += Math.sin(rad)*windSpeed*wFactor;
                this.vy *= 0.96; if(this.vy > -1.5) this.vy = -1.5;
                this.x+=this.vx; this.y+=this.vy; this.z+=this.vz;
                this.life-=1.8; this.baseSize*=0.96; if(this.life<60) this.g-=8;
            }
            draw() {
                const cosA=Math.cos(cameraAngle), sinA=Math.sin(cameraAngle);
                const rx = this.x*cosA - this.z*sinA; const rz = this.x*sinA + this.z*cosA;
                const persp = 600*cameraZoom; let scale = persp/(persp-rz);
                const vStackH = (groundY-torchY)*cameraZoom; const tipY = groundY-vStackH;
                const sx = centerX+(rx*scale); const sy = tipY+(this.y*scale*cameraZoom);
                const ss = this.baseSize*scale*cameraZoom;
                if(scale>0) {
                    ctx.beginPath(); ctx.arc(sx, sy, Math.max(0, ss), 0, Math.PI*2);
                    const a = this.life/100; let c = `rgba(${this.r},${this.g},0,${a})`;
                    if(this.life<25) c=`rgba(60,60,60,${a*0.4})`;
                    ctx.fillStyle=c; ctx.fill();
                }
            }
        }

        function calculatePhysics() {
            const vH = stackHeightMeters*pixelsPerMeter; torchY = groundY - vH;
            if(particles.length===0){ flameCenter={x:0,y:0,z:0}; maxGroundRadiation=0; return; }
            let sx=0, sy=0, sz=0, c=0;
            for(let p of particles){ if(p.life>40){ sx+=p.x; sy+=p.y; sz+=p.z; c++; } }
            if(c>0) flameCenter = {x:sx/c, y:sy/c, z:sz/c};
            const fRise = Math.abs(flameCenter.y);
            const totH = stackHeightMeters + (fRise/pixelsPerMeter);
            const distSq = totH*totH;
            qRadiantGlobal = (gasFlow*lhvValue) * radFraction;
            maxGroundRadiation = qRadiantGlobal / (4*Math.PI*distSq);

            const dr = document.getElementById('radValue');
            dr.innerText = maxGroundRadiation.toFixed(2);
            if(maxGroundRadiation>9.45) dr.style.color='#900';
            else if(maxGroundRadiation>6.3) dr.style.color='#f00';
            else if(maxGroundRadiation>4.75) dr.style.color='#f60';
            else if(maxGroundRadiation>2.7) dr.style.color='#fc0';
            else if(maxGroundRadiation>1.9) dr.style.color='#0f0';
            else dr.style.color='#fff';

            const lx = (flameCenter.x/pixelsPerMeter).toFixed(1);
            const lz = (flameCenter.z/pixelsPerMeter).toFixed(1);
            let tx = lx>=0 ? `${Math.abs(lx)}m E` : `${Math.abs(lx)}m O`;
            let tz = lz>=0 ? `${Math.abs(lz)}m S` : `${Math.abs(lz)}m N`;
            document.getElementById('radLoc').innerText = `${tz}, ${tx}`;
        }

        function drawScene() {
            const gS = ctx.createLinearGradient(0,0,0,canvas.height); gS.addColorStop(0,'#020205'); gS.addColorStop(0.6,'#0a1020'); gS.addColorStop(1,'#1a1510');
            ctx.fillStyle=gS; ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle='white'; stars.forEach(s=>{ ctx.globalAlpha=s.alpha; ctx.beginPath(); ctx.arc(s.x,s.y,s.size,0,Math.PI*2); ctx.fill(); }); ctx.globalAlpha=1;
            const gG = ctx.createLinearGradient(0,groundY,0,canvas.height); gG.addColorStop(0,'#151005'); gG.addColorStop(1,'#050300');
            ctx.fillStyle=gG; ctx.fillRect(0,groundY,canvas.width,canvas.height-groundY);
            ctx.strokeStyle='rgba(255,255,255,0.08)'; ctx.lineWidth=1; ctx.beginPath();
            const sz=2000, st=200, ca=Math.cos(cameraAngle), sa=Math.sin(cameraAngle);
            const proj = (x,z) => { const rx = x*ca - z*sa; const rz = x*sa + z*ca; const p = 600*cameraZoom; const s = p/(p-rz); return s<=0 ? null : {x:centerX+(rx*s), y:groundY+(100*s)}; };
            for(let x=-sz; x<=sz; x+=st){ let p1=proj(x,-sz), p2=proj(x,sz); if(p1&&p2){ ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); } }
            for(let z=-sz; z<=sz; z+=st){ let p1=proj(-sz,z), p2=proj(sz,z); if(p1&&p2){ ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); } }
            ctx.stroke();
            if(maxGroundRadiation>0.1) {
                const fx=flameCenter.x*4, fz=flameCenter.z*4; const rx=fx*ca-fz*sa, rz=fx*sa+fz*ca; const p=600*cameraZoom, s=p/(p-rz);
                if(s>0){ const gx=centerX+(rx*s), gr=(50+(maxGroundRadiation*100))*s*cameraZoom; const g=ctx.createRadialGradient(gx,groundY,10*s,gx,groundY,gr); g.addColorStop(0,`rgba(255,100,0,${Math.min(0.6,maxGroundRadiation*0.1)})`); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.save(); ctx.translate(gx,groundY); ctx.scale(1,0.3); ctx.beginPath(); ctx.arc(0,0,gr,0,Math.PI*2); ctx.fill(); ctx.restore(); }
            }
            const zh=cameraZoom, ch=(groundY-torchY)*zh, cty=groundY-ch, w=Math.max(15,tipDiameter*20)*zh;
            ctx.fillStyle='rgba(0,0,0,0.8)'; ctx.beginPath(); ctx.moveTo(centerX-w,groundY); ctx.lineTo(centerX+w,groundY); ctx.lineTo(centerX+w*1.5,groundY+50*zh); ctx.lineTo(centerX-w*1.5,groundY+50*zh); ctx.fill();
            const bw=w*3; ctx.strokeStyle='#2a2a2a'; ctx.lineWidth=2*zh; ctx.beginPath();
            ctx.moveTo(centerX-bw/2,groundY); ctx.lineTo(centerX-w/2,cty+20*zh); ctx.moveTo(centerX+bw/2,groundY); ctx.lineTo(centerX+w/2,cty+20*zh);
            let steps=10, dy=(groundY-cty)/steps;
            for(let i=0;i<steps;i++){ let y1=groundY-(dy*i), y2=groundY-(dy*(i+1)); let w1=bw/2-((bw/2-w/2)*(i/steps)), w2=bw/2-((bw/2-w/2)*((i+1)/steps)); ctx.moveTo(centerX-w1,y1); ctx.lineTo(centerX+w2,y2); ctx.moveTo(centerX+w1,y1); ctx.lineTo(centerX-w2,y2); ctx.moveTo(centerX-w1,y1); ctx.lineTo(centerX+w1,y1); }
            ctx.stroke();
            const gp=ctx.createLinearGradient(centerX-w/2,0,centerX+w/2,0); gp.addColorStop(0,'#111'); gp.addColorStop(0.5,'#666'); gp.addColorStop(1,'#000');
            ctx.fillStyle=gp; ctx.fillRect(centerX-w/2,cty,w,groundY-cty);
            ctx.fillStyle='#1a1a1a'; ctx.fillRect(centerX-(w+6*zh)/2,cty,w+6*zh,15*zh);
            ctx.fillStyle=`rgba(255,50,0,${Math.random()*0.5})`; ctx.fillRect(centerX-(w+4*zh)/2,cty,w+4*zh,2*zh);
        }

        // Radar en Pantalla (Fondo Oscuro)
        function drawScreenRadar() {
            const sz=260, r=sz/2, rx=canvas.width-r-30, ry=canvas.height-r-30, ms=0.2;
            ctx.save(); ctx.translate(rx,ry);
            ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fillStyle='rgba(0,10,15,0.95)'; ctx.strokeStyle='#00d2ff'; ctx.lineWidth=2; ctx.fill(); ctx.stroke();
            ctx.rotate(-cameraAngle);
            ctx.strokeStyle='#333'; ctx.fillStyle='#555'; ctx.font="9px Arial"; ctx.textAlign="center";
            [50,100,150].forEach(d=>{ const rp=d*pixelsPerMeter*ms; if(rp<r){ ctx.beginPath(); ctx.arc(0,0,rp,0,Math.PI*2); ctx.stroke(); ctx.save(); ctx.translate(0,-rp+10); ctx.rotate(cameraAngle); ctx.fillText(d+"m",0,0); ctx.restore(); } });
            ctx.strokeStyle='#444'; ctx.beginPath(); ctx.moveTo(0,-r); ctx.lineTo(0,r); ctx.moveTo(-r,0); ctx.lineTo(r,0); ctx.stroke();
            ctx.fillStyle='#00d2ff'; ctx.font="bold 11px Arial";
            const lbl=(t,x,y)=>{ ctx.save(); ctx.translate(x,y); ctx.rotate(cameraAngle); ctx.fillText(t,0,0); ctx.restore(); };
            lbl("N",0,-r+15); lbl("S",0,r-5); lbl("E",r-10,4); lbl("O",-r+10,4);
            const cx=flameCenter.x*ms, cy=flameCenter.z*ms;
            function getR(kw) { if(kw<=0)return 0; return Math.sqrt(qRadiantGlobal/(4*Math.PI*kw))*pixelsPerMeter*ms; }
            const niveles = [{k:1.9,c:'rgba(0,255,0,0.1)',s:'#0a0'}, {k:2.7,c:'rgba(255,200,0,0.1)',s:'#fa0'}, {k:4.75,c:'rgba(255,100,0,0.2)',s:'#f60'}, {k:6.3,c:'rgba(255,0,0,0.2)',s:'#f00'}, {k:9.45,c:'rgba(150,0,0,0.4)',s:'#900'}];
            const fxM = flameCenter.x/pixelsPerMeter, fzM = flameCenter.z/pixelsPerMeter;
            const rcX = cx, rcY = cy; 
            
            // L√ìGICA CORREGIDA: Solo dibujar si se supera el nivel
            niveles.forEach(n => { 
                if(maxGroundRadiation >= n.k) {
                    const r = getR(n.k); 
                    if(r>0){ ctx.beginPath(); ctx.arc(rcX, rcY, r, 0, Math.PI*2); ctx.fillStyle=n.c; ctx.fill(); ctx.strokeStyle=n.s; ctx.stroke(); } 
                }
            });

            if(maxGroundRadiation>0.1){ ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(rcX-5,rcY-5); ctx.lineTo(rcX+5,rcY+5); ctx.moveTo(rcX+5,rcY-5); ctx.lineTo(rcX-5,rcY+5); ctx.stroke(); }
            ctx.fillStyle='#00d2ff'; ctx.fillRect(-3,-3,6,6); ctx.restore();
        }

        function drawWindVane3D() {
            const sz=60, x=canvas.width-80, y=80;
            ctx.save(); ctx.translate(x,y);
            ctx.fillStyle='#888'; ctx.font="10px Arial"; ctx.textAlign="center"; ctx.fillText("VIENTO",0,-sz/2-10);
            ctx.strokeStyle='#444'; ctx.beginPath(); ctx.arc(0,0,sz/2,0,Math.PI*2); ctx.stroke();
            ctx.fillStyle='#666'; ctx.fillText("N",0,-sz/2+10);
            ctx.rotate((windAngleDeg*(Math.PI/180))-cameraAngle);
            ctx.beginPath(); ctx.moveTo(0,-sz/2+5); ctx.lineTo(10,5); ctx.lineTo(5,5); ctx.lineTo(5,sz/3); ctx.lineTo(-5,sz/3); ctx.lineTo(-5,5); ctx.lineTo(-10,5); ctx.closePath();
            ctx.fillStyle='#00d2ff'; ctx.fill(); ctx.restore();
        }

        function animate() {
            calculatePhysics(); drawScene();
            drawWindVane3D();
            ctx.globalCompositeOperation='source-over'; drawScreenRadar();
            ctx.globalCompositeOperation='lighter';
            particles.sort((a,b)=>a.z-b.z);
            const sp = Math.floor(gasFlow/5); for(let i=0;i<sp;i++) particles.push(new Particle());
            for(let i=0;i<particles.length;i++){ particles[i].update(); particles[i].draw(); if(particles[i].life<=0){ particles.splice(i,1); i--; } }
            ctx.globalCompositeOperation='source-over';
            requestAnimationFrame(animate);
        }

        window.addEventListener('resize', ()=>{ canvas.width=window.innerWidth; canvas.height=window.innerHeight; groundY=canvas.height-50; stars.length=0; for(let i=0;i<100;i++) stars.push({x:Math.random()*window.innerWidth, y:Math.random()*window.innerHeight*0.6, size:Math.random()*2, alpha:Math.random()}); });
        animate();
    </script>
</body>
</html>
